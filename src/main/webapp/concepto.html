
<style>
    /* Ajuste del ancho de la tabla */
    #conceptoTable {
        width: 100%;
        max-width: 900px;
        margin: auto;
        font-size: 14px;
        table-layout: auto; /* Asegura que el tamaño de las columnas se ajuste automáticamente */
        word-wrap: break-word; /* Permite que el texto largo se ajuste sin cortar */
    }

    /* Estilos para las celdas de la tabla */
    #conceptoTable th,
    #conceptoTable td {
        white-space: normal; /* Permite que el texto ocupe más de una línea si es necesario */
        word-wrap: break-word; /* Hace que el texto largo se ajuste y no desborde */
        overflow: visible; /* Permite que el texto se muestre sin ser recortado */
        text-overflow: unset; /* Elimina el recorte de texto con "..." */
    }

    /* Definir el ancho de las columnas */
    #conceptoTable th:nth-child(1),
    #conceptoTable td:nth-child(1) {
        width: 5%; /* Código */
    }

    #conceptoTable th:nth-child(2),
    #conceptoTable td:nth-child(2) {
        width: 8%; /* Orden */
    }

    #conceptoTable th:nth-child(3),
    #conceptoTable td:nth-child(3) {
        width: 20%; /* Nombre */
    }

    #conceptoTable th:nth-child(4),
    #conceptoTable td:nth-child(4) {
        width: 10%; /* Tipo */
    }

    #conceptoTable th:nth-child(5),
    #conceptoTable td:nth-child(5) {
        width: 12%; /* Categoría */
    }

    #conceptoTable th:nth-child(6),
    #conceptoTable td:nth-child(6) {
        width: 17%; /* Fórmula */
    }

    #conceptoTable th:nth-child(7),
    #conceptoTable td:nth-child(7) {
        width: 10%; /* Valor */
    }

    #conceptoTable th:nth-child(8),
    #conceptoTable td:nth-child(8) {
        width: 7%; /* Visible */
    }

    #conceptoTable th:nth-child(9),
    #conceptoTable td:nth-child(9) {
        width: 20%; /* Acciones */
        text-align: center;
    }

    /* Responsividad para pantallas pequeñas */
    @media screen and (max-width: 768px) {
        #conceptoTable {
            width: 100%;
            font-size: 12px; /* Reduce el tamaño del texto en pantallas pequeñas */
        }
    }

</style>

<div class="container mt-4">
    <div class="card">
        <div class="card-body">
            <div class="d-flex align-items-center">
                <h1 class="h3 mb-0 text-gray-800">Gestión de Conceptos</h1>
            </div>   

            <nav class="navbar navbar-light bg-white p-2">
                <div class="container-fluid d-flex align-items-center p-0">
                    <div class="d-flex align-items-center me-3"></div>

                    <!-- Grupo de Botones -->
                    <div class="btn-group" style="gap: 1rem;">
                        <div class="btn-group">
                            <select id="cmbPlantilla" class="form-select"></select>
                        </div>
                        <button class="btn btn-primary me-2" id="btnAddConcepto">
                            <i class="fas fa-fw fa-plus me-2"></i>
                            <span>Nuevo</span>
                        </button>
                        <button class="btn btn-primary me-2" id="btnPDF">
                            <i class="fas fa-fw fa-print"></i>
                            <span>Imprimir</span>
                        </button>
                        <button class="btn btn-primary me-2" id="btnExportar">
                            <i class="fas fa-fw fa-file-excel"></i>
                            <span>Exportar</span>
                        </button>
                        <button class="btn btn-primary me-2" id="btnClonar">
                            <i class="fas fa-fw fa-clone"></i>
                            <span>Clonar</span>
                        </button>
                    </div>
                </div>
            </nav>


            <hr/>
            <table id="conceptoTable" class="table table-striped table-bordered w-100">
                <thead>
                    <tr>
                        <th>Código</th>
                        <th>Orden</th>
                        <th>Nombre</th>
                        <th>Tipo</th>
                        <th>Categoría</th>
                        <th>Fórmula</th>
                        <th>Valor</th>
                        <th>Visible</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Se llenará dinámicamente con DataTables -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Modal para Agregar/Editar Concepto -->
<div class="modal fade" id="conceptoModal" tabindex="-1" aria-labelledby="conceptoModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="conceptoForm">
                <div class="modal-header">
                    <h5 class="modal-title" id="conceptoModalLabel">Agregar Concepto</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="codiConc" name="codiConc">
                    <input type="hidden" id="codiPlant" name="codiPlant">
                    <div class="mb-4">
                        <label for="nombConc" class="form-label d-block mb-2">Nombre</label>
                        <input type="text" class="form-control" id="nombConc" name="nombConc" required>
                    </div>
                    <div class="mb-4">
                        <label for="tipoConc" class="form-label">Tipo</label>
                        <select class="form-select" id="tipoConc" name="tipoConc">
                            <option value="1">VALOR</option>
                            <option value="2">FORMULA</option>
                        </select>
                    </div>
                    <div class="mb-4">
                        <label for="cateConc" class="form-label">Categoría</label>
                        <select class="form-select" id="cateConc" name="cateConc">
                            <option value="1">SISTEMA</option>
                            <option value="2">INGRESOS</option>
                            <option value="3">EGRESOS</option>
                            <option value="4">APORTES</option>
                            <option value="5">TOTAL</option>
                        </select>
                    </div>
                    <div class="mb-4">
                        <label for="formula" class="form-label">Fórmula</label>
                        <input type="text" class="form-control" id="formula" name="formula">
                    </div>
                    <div class="mb-4">
                        <label for="valor" class="form-label">Valor</label>
                        <input type="number" step="0.0001" class="form-control" id="valor" name="valor">
                    </div>
                    <div class="mb-4">
                        <label for="ordnConc" class="form-label">Orden</label>
                        <input type="number" class="form-control" id="ordnConc" name="ordnConc">
                    </div>
                    <div class="mb-4">
                        <label for="visible" class="form-label">Visible</label>
                        <select class="form-select" id="visible" name="visible">
                            <option value="true">Sí</option>
                            <option value="false">No</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Guardar</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Clonar-->
<div class="modal fade" id="clonarModal" tabindex="-1" aria-labelledby="clonarModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">   
            <div class="modal-header">
                <h5 class="modal-title" id="conceptoModalLabel">Clonar Plantilla Completa</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="nombPlant" class="form-label">Nombre:</label>
                    <input type="text" class="form-control" id="nombPlant" name="nombPlant" required>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" id="btnClonarPlantilla" class="btn btn-primary">Clonar</button>
            </div>
        </div>
    </div>
</div>

<script>
    $(document).ready(function () {
        // Cargar opciones de plantilla
        let cargarPlantillas = function () {
            $.getJSON("plantillaservlet", function (data) {
                var select = $('#cmbPlantilla');

                // Limpiar las opciones existentes
                select.empty();

                // Iterar sobre el array de plantillas y crear las opciones
                $.each(data, function (index, plantilla) {
                    select.append('<option value="' + plantilla.codiPlant + '">' + plantilla.nombPlant + '</option>');
                });

            }).fail(function () {
                alert("Error al cargar las plantillas.");
                // Opcional: Manejar errores visualmente
                // $('#plantilla-container').html('<p>Error al cargar las plantillas.</p>');
            });
        };
        cargarPlantillas();

        // Inicializar DataTable

        const conceptoTable = $('#conceptoTable').DataTable({
            ajax: {
                url: 'conceptoservlet',
                type: 'GET',
                dataSrc: ''
            },
            columns: [
                {data: 'codiConc'},
                {data: 'ordnConc'}, // Mostrar la columna 'Orden'
                {data: 'nombConc'},
                {data: 'tipoConc', render: function (data, type, row) {
                        switch (data) {
                            case 1:
                                return 'VALOR';
                            case 2:
                                return 'FORMULA';
                        }
                    }},
                {data: 'cateConc', render: function (data, type, row) {
                        switch (data) {
                            case 1:
                                return 'SISTEMA';
                            case 2:
                                return 'INGRESOS';
                            case 3:
                                return 'EGRESOS';
                            case 4:
                                return 'APORTES';
                            case 5:
                                return 'TOTAL';
                        }
                    }},
                {data: 'formula'},
                {data: 'valor'},
                {data: 'visible', render: function (data) {
                        return data ? 'Sí' : 'No';
                    }},
                {
                    data: null,
                    render: function (data, type, row) {
                        return `
                            <button class="btn btn-primary btn-sm btnEdit" data-id="${row.codiConc}">
                                <i class="fas fa-edit"></i> Editar
                            </button>
                        `;
                    }
                }
            ],
            pageLength: 100,
            language: {
                url: '//cdn.datatables.net/plug-ins/2.0.3/i18n/es-ES.json'
            }
        });
        // Filtrar la tabla por búsqueda
        $('#txtBuscar').on('input', function () {
            conceptoTable.search(this.value).draw();
        });

        // Imprimir tabla como PDF
        $('#btnPDF').click(function () {
            const {jsPDF} = window.jspdf;
            const doc = new jsPDF();
            var tableData = [];
            $('#conceptoTable thead th').each(function (i, header) {
                tableData.push($(header).text());
            });
            var rows = [];
            $('#conceptoTable tbody tr').each(function () {
                var rowData = [];
                $(this).find('td').each(function (i, cell) {
                    rowData.push($(cell).text());
                });
                rows.push(rowData);
            });
            doc.autoTable({
                head: [tableData],
                body: rows,
                startY: 20
            });
            doc.save('conceptos.pdf');
        });

        // Exportar tabla a Excel
        $('#btnExportar').click(function () {
            var tableData = [];
            var headers = [];
            $('#conceptoTable thead th').each(function (i, header) {
                if (i < $('#conceptoTable thead th').length - 1) {
                    headers.push($(header).text());
                }
            });

            // Primer fila con el título (fuera de los datos de la tabla)
            var titleRow = [$('#cmbPlantilla').val()]; // Título que quieres mostrar
            tableData.push(titleRow);  // Añadir el título en la primera fila

            // Añadir una fila vacía para separar el título de los datos
            tableData.push(new Array(headers.length).fill(''));

            // Datos de la tabla
            tableData.push(headers);

            $('#conceptoTable tbody tr').each(function () {
                var rowData = [];
                $(this).find('td').each(function (i, cell) {
                    if (i < $('#conceptoTable thead th').length - 1) {
                        rowData.push($(cell).text());
                    }
                });
                tableData.push(rowData);
            });

            // Crear la hoja de trabajo
            var ws = XLSX.utils.aoa_to_sheet(tableData);

            // Combinar celdas para el título
            ws['!merges'] = [{s: {r: 0, c: 0}, e: {r: 0, c: tableData[0].length - 1}}];

            // Establecer el estilo de la celda combinada (centrado, negrita, tamaño 14)
            ws['A1'].s = {
                font: {bold: true, sz: 14},
                alignment: {horizontal: 'center', vertical: 'center'},
            };

            // Crear libro de trabajo
            var wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Conceptos");

            // Descargar el archivo Excel
            XLSX.writeFile(wb, "conceptos.xlsx");
        });


        // Agregar concepto nuevo

        $('#btnAddConcepto').click(function () {
            $('#conceptoForm')[0].reset();
            $('#codiPlant').val($('#cmbPlantilla').val()); // Asegúrate de que el valor seleccionado se asigna al campo oculto
            $('#conceptoModalLabel').text('Agregar Concepto');
            $('#conceptoModal').modal('show');
        });


        $('#btnClonar').click(function () {
            $('#clonarModal').modal('show');
        });

        $('#btnClonarPlantilla').click(function () {
            let codiPlantOrig = $('#cmbPlantilla').val();

            let nombrePlantilla = $('#nombPlant').val();
            let parametro = {codiPlantOrig: codiPlantOrig, nombrePlantilla: nombrePlantilla};
            $.get('clonarplantillaservlet', parametro, function (data) {
                //console.log(data);
                if (data.resultado === "ok") {
                    cargarPlantillas();
                    $('#clonarModal').modal('hide');
                    $('#cmbPlantilla').val(data.codigo);
                    $('#cmbPlantilla').trigger('change');
                } else {
                    alert('Ocurrió un error al guardar el concepto.');
                }
            });
        });



        // Editar concepto
        $('#conceptoTable tbody').on('click', '.btnEdit', function () {
            const id = $(this).data('id');
            $.get('conceptoservlet/' + id, function (data) {
                $('#codiConc').val(data.codiConc);
                $('#codiPlant').val();
                $('#nombConc').val(data.nombConc);
                $('#formula').val(data.formula);
                $('#valor').val(data.valor);
                $('#ordnConc').val(data.ordnConc);
                $('#visible').val(data.visible);
                $('#conceptoModalLabel').text('Editar Concepto');
                $('#conceptoModal').modal('show');
            });
        });


        // Eliminar concepto
        $('#conceptoTable tbody').on('click', '.btnEdit', function () {
            const id = $(this).data('id');
            $.get('conceptoservlet/' + id, function (data) {
                $('#codiConc').val(data.codiConc);

                // Asignar el valor de la plantilla seleccionada al campo oculto
                $('#codiPlant').val($('#cmbPlantilla').val()); // Aquí se asigna el valor seleccionado al campo

                $('#nombConc').val(data.nombConc);
                $('#formula').val(data.formula);
                $('#valor').val(data.valor);
                $('#ordnConc').val(data.ordnConc);
                $('#visible').val(data.visible);
                $('#conceptoModalLabel').text('Editar Concepto');
                $('#conceptoModal').modal('show');
            });
        });

        // Guardar o actualizar concepto
        $('#conceptoForm').submit(function (e) {
            e.preventDefault();

            const id = $('#codiConc').val();
            const url = id ? 'conceptoservlet/' + id : 'conceptoservlet';
            const method = id ? 'PUT' : 'POST';

            $.ajax({
                url: url,
                type: method,
                data: $(this).serialize(),
                success: function () {
                    $('#conceptoModal').modal('hide');
                    conceptoTable.ajax.reload();
                },
                error: function () {
                    alert('Ocurrió un error al guardar el concepto.');
                }
            });
        });

        $('#cmbPlantilla').on('change', function () {
            var selectedPlantilla = $(this).val(); // Obtener el valor de la plantilla seleccionada
            $('#codiPlant').val(selectedPlantilla);
            conceptoTable.ajax.url('conceptoservlet?plantilla=' + selectedPlantilla).load(); // Recargar DataTable con los datos filtrados
        });
        $('#conceptoModal .btn-close, #conceptoModal .btn-secondary').click(function () {
            $('#conceptoModal').modal('hide');
        });
    });
</script>
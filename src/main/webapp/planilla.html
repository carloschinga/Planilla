<div class="container mt-4">
    <div class="card">
        <div class="card-body">
            <div class="position-relative d-flex align-items-center">
                <h1 class="h3 mb-0 text-gray-800">Gestión de Planillas</h1>
            </div>          
            <nav class="navbar navbar-light bg-white p-2">
                <div class="container-fluid d-flex align-items-center" style="padding-left: 0px;padding-right: 0px;">
                    <!-- Selector de Periodo -->
                    <div class="d-flex align-items-center me-3">

                    </div>

                    <!-- Grupo de Botones -->
                    <div class="btn-group">
                        <select id="cmbPeriodo" class="form-select form-select-sm" style="width: auto;"></select>
                        <button class="btn btn-primary" id="btnGenerar">
                            <i class="fas fa-table"></i> Generar
                        </button>
                        <button class="btn btn-primary" id="btnCalcular">
                            <i class="fas fa-cogs"></i> Calcular
                        </button>
                        <button class="btn btn-primary" id="btnPDF">
                            <i class="fas fa-print"></i> Imprimir
                        </button>
                        <button class="btn btn-primary" id="btnExportar">
                            <i class="fas fa-file-excel"></i> Exportar
                        </button>
                    </div>

                </div>
            </nav>
            <hr/>
            <div class="d-flex align-items-center me-3">
                <label for="cmbPersona" class="me-2 mb-0 fw-bold">Persona:</label>       
                <select id="cmbPersona" class="form-select form-select-sm" style="width: auto;"></select>
            </div>

            <br/>

            <table id="planillaconceptoTable" class="table table-striped table-bordered" style="width:100%;overflow-x: auto;">
                <thead>
                    <tr>
                        <th>Código</th>
                        <th>Nombre</th>
                        <th>Formula</th>
                        <th>Valor</th>
                        <th>Visible</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Se llenará dinámicamente con DataTables -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Modal para Agregar/Editar Concepto -->
<div class="modal fade" id="conceptoModal" tabindex="-1" aria-labelledby="conceptoModalLabel" inert>
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="conceptoForm">
                <div class="modal-header">
                    <h5 class="modal-title" id="conceptoModalLabel">Agregar Concepto</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="codiConc" name="codiConc">
                    <div class="mb-3">
                        <label for="nombConc" class="form-label">Nombre</label>
                        <input type="text" class="form-control" id="nombConc" name="nombConc" required>
                    </div>
                    <div class="mb-3">
                        <label for="tipoConc" class="form-label">Tipo</label>
                        <input type="number" class="form-control" id="tipoConc" name="tipoConc" required>
                    </div>
                    <div class="mb-3">
                        <label for="cateConc" class="form-label">Categoría</label>
                        <input type="number" class="form-control" id="cateConc" name="cateConc" required>
                    </div>
                    <div class="mb-3">
                        <label for="formula" class="form-label">Fórmula</label>
                        <input type="text" class="form-control" id="formula" name="formula">
                    </div>
                    <div class="mb-3">
                        <label for="valor" class="form-label">Valor</label>
                        <input type="number" step="0.0001" class="form-control" id="valor" name="valor">
                    </div>

                    <div class="mb-3">
                        <label for="visible" class="form-label">Visible</label>
                        <select class="form-select" id="visible" name="visible">
                            <option value="true">Sí</option>
                            <option value="false">No</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Guardar</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    $(document).ready(function () {
        $.getJSON("periodoservlet", function (data) {
            var select = $('#cmbPeriodo');
            select.empty();

            $.each(data, function (index, periodo) {
                select.append('<option value="' + periodo.codiPeri + '">' + periodo.nombPeri + '</option>');
            });
            actualizarPersonas($('#cmbPeriodo').val());
        }).fail(function () {
            alert("error");
        });

        function actualizarPersonas(periodo) {
            let parametro = {periodo: periodo};
            $.getJSON("planillapersonaservlet", parametro, function (data) {
                var select = $('#cmbPersona');
                select.empty();
                $.each(data, function (index, persona) {
                    select.append('<option value="' + persona.codiPers + '">' + persona.nombPers + '</option>');
                });
            }).fail(function () {
                alert("Error al cargar auxiliares");
            });
        }

        const planillaconceptoTable = $('#planillaconceptoTable').DataTable({
            ajax: {
                url: 'planillaconceptoservlet',
                type: 'GET',
                dataSrc: ''
            },
            columns: [
                {data: 'codiConc'},
                {data: 'nombConc'},
                {data: 'formula'},
                {data: 'valor',
                    render: function (data) {
                        return parseFloat(data).toFixed(2);
                    }
                },
                {data: 'visible', render: function (data) {
                        return data ? 'Sí' : 'No';
                    }
                }
            ],
            dom: 't',
            paging: false,
            info: false,
             pageLength: 100,
            language: {
                emptyTable: "No hay datos disponibles en la tabla"
            }
        });

        $('#btnGenerar').click(function () {
            var selectedPeriodo = $('#cmbPeriodo').val();
            let parametro = {periodo: selectedPeriodo, accion: 1};

            $.getJSON("planillaservlet", parametro, function (data) {
                if (data.resultado === "ok") {
                    var selectedPeriodo = $('#cmbPeriodo').val();
                    actualizarPersonas(selectedPeriodo);
                    var selectedPersona = $('#cmbPersona').val();
                    planillaconceptoTable.ajax.url('planillaconceptoservlet?periodo=' + selectedPeriodo + "&persona=" + selectedPersona).load();
                } else {
                    alert("Problemas al generar planilla");
                }
            }).fail(function () {
                alert("Error al generar la planilla");
            });
        });

        $('#btnCalcular').click(function () {
            var selectedPeriodo = $('#cmbPeriodo').val();
            let parametro = {periodo: selectedPeriodo, accion: 2};
            $.getJSON("planillaservlet", parametro, function (data) {
                if (data.resultado === "ok") {
                    alert("Se calculó correctamente");
                    var selectedPeriodo = $('#cmbPeriodo').val();
                    actualizarPersonas(selectedPeriodo);
                    var selectedPersona = $('#cmbPersona').val();
                    planillaconceptoTable.ajax.url('planillaconceptoservlet?periodo=' + selectedPeriodo + "&persona=" + selectedPersona).load();
                } else {
                    alert("Problemas al calcular planilla");
                }
            }).fail(function () {
                alert("Error al calcular la planilla");
            });
        });

        $('#txtBuscar').on('input', function () {
            planillaconceptoTable.search(this.value).draw();
        });

        $('#btnPDF').click(function () {
            const {jsPDF} = window.jspdf;
            const doc = new jsPDF();

            var tableData = [];
            $('#planillaconceptoTable thead th').each(function (i, header) {
                tableData.push($(header).text());
            });

            var rows = [];
            $('#planillaconceptoTable tbody tr').each(function () {
                var rowData = [];
                $(this).find('td').each(function (i, cell) {
                    rowData.push($(cell).text());
                });
                rows.push(rowData);
            });

            doc.autoTable({
                head: [tableData],
                body: rows,
                startY: 20
            });

            doc.save('conceptos.pdf');
        });

        $('#btnExportar').click(function () {
            var tableData = [];
            var headers = [];
            $('#planillaconceptoTable thead th').each(function (i, header) {
                if (i < $('#planillaconceptoTable thead th').length - 1) {
                    headers.push($(header).text());
                }
            });
            tableData.push(headers);

            $('#planillaconceptoTable tbody tr').each(function () {
                var rowData = [];
                $(this).find('td').each(function (i, cell) {
                    if (i < $(this).parent().find('td').length - 1) {
                        rowData.push($(cell).text());
                    }
                });
                tableData.push(rowData);
            });

            var ws = XLSX.utils.aoa_to_sheet(tableData);
            var wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Planilla');
            XLSX.writeFile(wb, 'planilla.xlsx');
        });

        $('#cmbPeriodo').on('change', function () {
            var selectedPeriodo = $(this).val();
            actualizarPersonas(selectedPeriodo);
        });

        $('#cmbPersona').on('change', function () {
            var selectedPersona = $(this).val();
            var selectedPeriodo = $('#cmbPeriodo').val();
            planillaconceptoTable.ajax.url('planillaconceptoservlet?periodo=' + selectedPeriodo + "&persona=" + selectedPersona).load();
        });

        $('#conceptoModal').on('shown.bs.modal', function () {
            $(this).find('button, input, select').first().focus();
        });

    });
</script>
